<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fencing Academy Super App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            500: '#f97316', // Orange
                            600: '#ea580c',
                            dark: '#1f2937',
                            success: '#22c55e',
                            danger: '#ef4444'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Tab Transitions */
        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Checkbox */
        .custom-checkbox:checked + div { background-color: #f97316; border-color: #f97316; }
        .custom-checkbox:checked + div svg { display: block; }

        /* Login Screen Transitions */
        #login-screen { transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        #main-app { display: none; opacity: 0; transition: opacity 0.5s ease-in; }
        .fade-in { opacity: 1 !important; }
        
        /* Input Focus Styling */
        .auth-input:focus-within { border-color: #f97316; ring: 2px solid #ffedd5; }
        
        /* Bottom Safe Area padding for iPhones */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased flex justify-center min-h-screen">

    <!-- === 0. LOGIN SCREEN === -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 w-full max-w-md mx-auto shadow-2xl">
        <div class="w-full max-w-xs flex flex-col items-center">
            <!-- Logo Area -->
            <div class="w-24 h-24 bg-brand-50 rounded-full flex items-center justify-center mb-6 relative overflow-hidden">
                <i class="fa-solid fa-shield-halved text-5xl text-brand-500"></i>
                <div class="absolute -bottom-2 w-full h-2 bg-gradient-to-t from-brand-100 to-transparent"></div>
            </div>
            
            <h1 class="text-2xl font-extrabold text-brand-dark mb-1 text-center leading-tight">Академия фехтования<br>Manuel</h1>
            <p class="text-gray-400 text-sm mb-8 text-center mt-2">Вход в личный кабинет</p>

            <!-- Input Form -->
            <div class="w-full space-y-4">
                
                <!-- Email Input -->
                <div class="relative group">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 pl-1">E-mail (Логин)</label>
                    <div class="flex items-center border-2 border-gray-100 rounded-xl px-4 py-3 bg-gray-50 transition-colors focus-within:bg-white focus-within:border-brand-500 auth-input">
                        <i class="fa-regular fa-envelope text-gray-300 mr-3 group-focus-within:text-brand-500 transition-colors"></i>
                        <input type="email" id="email-input" placeholder="example@mail.ru" class="bg-transparent border-none outline-none w-full font-bold text-lg text-brand-dark placeholder-gray-300">
                    </div>
                </div>

                <!-- Password Input -->
                <div class="relative group">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 pl-1">Пароль</label>
                    <div class="flex items-center border-2 border-gray-100 rounded-xl px-4 py-3 bg-gray-50 transition-colors focus-within:bg-white focus-within:border-brand-500 auth-input">
                        <i class="fa-solid fa-lock text-gray-300 mr-3 group-focus-within:text-brand-500 transition-colors"></i>
                        <input type="password" id="password-input" placeholder="••••••••" class="bg-transparent border-none outline-none w-full font-bold text-lg text-brand-dark placeholder-gray-300">
                    </div>
                </div>
                
                <button onclick="handleLogin()" id="login-btn" class="w-full bg-brand-dark text-white font-bold py-4 rounded-xl shadow-lg hover:bg-gray-800 active:scale-95 transition-all flex items-center justify-center gap-2 group disabled:opacity-50 disabled:cursor-not-allowed mt-2">
                    <span>Войти</span>
                    <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
                
                <!-- Demo Button (Fallback) -->
                <button onclick="loginAsDemo()" class="w-full bg-brand-50 text-brand-600 font-bold py-3 rounded-xl hover:bg-brand-100 transition-colors text-sm border border-brand-100">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Демо-вход
                </button>

                <p id="login-error" class="text-red-500 text-xs text-center hidden bg-red-50 p-2 rounded-lg border border-red-100">
                    Ошибка входа. Проверьте логин и пароль.
                </p>
                <p id="cors-warning" class="text-orange-500 text-[10px] text-center hidden mt-2">
                    <b>Внимание:</b> Браузер блокирует CORS запросы.<br>
                    Используйте расширение "Allow CORS" или Демо-вход.
                </p>
            </div>

            <p class="mt-8 text-xs text-center text-gray-300">
                Забыли пароль? <a href="#" class="underline hover:text-brand-500">Восстановить</a>
            </p>
        </div>
    </div>

    <!-- === APP CONTAINER (Initially Hidden) === -->
    <div id="main-app" class="w-full max-w-md bg-gray-50 min-h-screen shadow-2xl relative pb-24 overflow-hidden flex flex-col">

        <!-- === TOP HEADER (Sticky) === -->
        <header class="bg-white p-4 sticky top-0 z-20 shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 font-bold border-2 border-white shadow-sm relative">
                        <i class="fa-solid fa-user-astronaut"></i>
                        <!-- Online Status Indicator -->
                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></div>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Родитель</p>
                        <h1 id="header-username" class="text-lg font-extrabold text-brand-dark leading-none">...</h1>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <!-- Message Coach Button -->
                    <button onclick="contactCoach()" class="w-9 h-9 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-brand-50 hover:text-brand-500 transition">
                        <i class="fa-regular fa-paper-plane"></i>
                    </button>
                    <!-- Balance Badge (Opens Finance Tab) -->
                    <div onclick="showTab('finance')" class="bg-gray-900 text-white px-3 py-1.5 rounded-xl flex items-center gap-2 shadow-lg active:scale-95 transition-transform cursor-pointer">
                        <i class="fa-solid fa-wallet text-brand-500 text-xs"></i>
                        <span class="text-xs font-bold" id="header-balance">...</span>
                    </div>
                </div>
            </div>

            <!-- Child Switcher (Loaded from API) -->
            <div class="flex space-x-2 overflow-x-auto no-scrollbar" id="children-container">
                <!-- Injected via JS -->
            </div>
        </header>

        <!-- ================= SCREENS ================= -->

        <!-- 1. HOME SCREEN -->
        <div id="tab-home" class="tab-content active px-4 pt-4">
            
            <div class="mb-2"></div> <!-- Spacer -->

            <!-- Gamification Card -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 relative overflow-hidden mb-6">
                <div class="absolute right-0 top-0 text-gray-50 opacity-10 text-8xl -mr-4 -mt-4 pointer-events-none">
                    <i class="fa-solid fa-medal"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <span class="bg-brand-100 text-brand-700 text-[10px] font-bold px-2 py-0.5 rounded mb-1 inline-block" id="home-rank-badge">Загрузка...</span>
                            <h2 class="text-2xl font-extrabold text-brand-dark" id="home-rank">...</h2>
                        </div>
                        <div class="text-right">
                            <span class="text-xl font-bold text-brand-500" id="home-xp">0</span>
                            <span class="text-[10px] text-gray-400 font-bold uppercase">XP</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2.5">
                        <div id="xp-bar" class="bg-gradient-to-r from-brand-500 to-yellow-400 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 flex items-center gap-1" id="home-streak">
                        <i class="fa-solid fa-fire text-brand-500"></i> Загрузка...
                    </p>
                </div>
            </div>

            <!-- Urgent: Next Training -->
            <h3 class="text-sm font-bold text-gray-900 mb-2 px-1">Ближайшая тренировка</h3>
            <div class="bg-brand-dark text-white rounded-2xl p-4 shadow-lg mb-6 flex justify-between items-center relative overflow-hidden group cursor-pointer" onclick="showTab('calendar')">
                <div class="absolute inset-0 bg-brand-500 opacity-0 group-active:opacity-10 transition-opacity"></div>
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold backdrop-blur-sm" id="next-lesson-date">...</span>
                        <span class="text-brand-500 font-bold text-sm" id="next-lesson-time">...</span>
                    </div>
                    <p class="font-bold text-lg" id="next-lesson-title">Загрузка расписания...</p>
                    <p class="text-xs text-gray-400"><i class="fa-solid fa-location-dot mr-1"></i><span id="next-lesson-loc">Зал академии</span></p>
                </div>
                <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-xl">
                    <i class="fa-solid fa-chevron-right"></i>
                </div>
            </div>

            <!-- Quick Actions Grid -->
            <h3 class="text-sm font-bold text-gray-900 mb-2 px-1">Быстрые действия</h3>
            <div class="grid grid-cols-3 gap-3 mb-20">
                <!-- Report Absence -->
                <div onclick="reportAbsence()" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition-transform flex flex-col items-center justify-center text-center h-28 cursor-pointer group">
                    <div class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center mb-2 group-hover:bg-red-100 transition">
                        <i class="fa-solid fa-user-xmark"></i>
                    </div>
                    <p class="font-bold text-[11px] leading-tight">Сообщить<br>о пропуске</p>
                </div>
                
                <div onclick="showTab('calendar')" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition-transform flex flex-col items-center justify-center text-center h-28 cursor-pointer">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center mb-2">
                        <i class="fa-solid fa-calendar-day"></i>
                    </div>
                    <p class="font-bold text-[11px] leading-tight">Мое<br>расписание</p>
                </div>

                <div onclick="showTab('market')" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition-transform flex flex-col items-center justify-center text-center h-28 cursor-pointer">
                    <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center mb-2">
                        <i class="fa-solid fa-shop"></i>
                    </div>
                    <p class="font-bold text-[11px] leading-tight">Барахолка<br>клуба</p>
                </div>
            </div>
        </div>

        <!-- 2. CALENDAR SCREEN -->
        <div id="tab-calendar" class="tab-content px-4 pt-4">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4">Календарь занятий</h2>
            
            <!-- Date Picker Scroller -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-2">
                <div onclick="selectDate(this)" class="flex-shrink-0 w-14 h-20 bg-brand-500 rounded-xl flex flex-col items-center justify-center text-white shadow-lg scale-105 transform transition-all cursor-pointer ring-2 ring-brand-200">
                    <span class="text-xs font-medium opacity-80">ПН</span>
                    <span class="text-xl font-bold">20</span>
                </div>
                <div onclick="selectDate(this)" class="flex-shrink-0 w-14 h-20 bg-white border border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-600 cursor-pointer hover:border-brand-300 transition-colors">
                    <span class="text-xs font-medium text-gray-400">ВТ</span>
                    <span class="text-xl font-bold">21</span>
                </div>
                <div onclick="selectDate(this)" class="flex-shrink-0 w-14 h-20 bg-white border border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-600 relative cursor-pointer hover:border-brand-300 transition-colors">
                    <span class="text-xs font-medium text-gray-400">СР</span>
                    <span class="text-xl font-bold">22</span>
                    <div class="absolute bottom-2 w-1.5 h-1.5 bg-red-500 rounded-full"></div>
                </div>
                 <div onclick="selectDate(this)" class="flex-shrink-0 w-14 h-20 bg-white border border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-600 cursor-pointer hover:border-brand-300 transition-colors">
                    <span class="text-xs font-medium text-gray-400">ЧТ</span>
                    <span class="text-xl font-bold">23</span>
                </div>
            </div>

            <!-- Schedule List -->
            <div class="space-y-3 pb-20">
                <div class="bg-white rounded-xl p-4 border-l-4 border-brand-500 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">Групповая тренировка</p>
                            <p class="text-xs text-gray-500 mt-1">18:00 - 19:30 • Тренер Виктор</p>
                        </div>
                        <span class="bg-brand-50 text-brand-600 text-[10px] font-bold px-2 py-1 rounded">Завтра</span>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-4 border-l-4 border-green-500 shadow-sm opacity-70">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">Спарринги</p>
                            <p class="text-xs text-gray-500 mt-1">18:00 - 19:30 • 18 Октября</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-4 border-l-4 border-red-500 shadow-sm opacity-70">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">ОФП Подготовка</p>
                            <p class="text-xs text-gray-500 mt-1">16 Октября</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. REPORTS SCREEN -->
        <div id="tab-reports" class="tab-content px-4 pt-4">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4">Отчеты успеваемости</h2>
            <div id="reports-list" class="space-y-4 pb-20">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- 4. CLUB (Tournaments & Market) -->
        <div id="tab-market" class="tab-content px-4 pt-4">
            
            <div class="flex justify-between items-end mb-3">
                <h2 class="text-xl font-extrabold text-gray-900">Ближайший турнир</h2>
            </div>
            
            <div class="bg-gradient-to-br from-brand-dark to-gray-800 text-white rounded-2xl p-5 shadow-lg mb-8 relative overflow-hidden">
                <div class="absolute right-0 bottom-0 opacity-10 text-9xl -mr-6 -mb-6">
                    <i class="fa-solid fa-trophy"></i>
                </div>
                <div class="relative z-10">
                    <span class="bg-yellow-400 text-black text-[10px] font-bold px-2 py-0.5 rounded mb-2 inline-block">Важно</span>
                    <h3 class="text-xl font-bold mb-1">Кубок "Юная Шпага"</h3>
                    <p class="text-xs text-gray-300 mb-4"><i class="fa-regular fa-calendar mr-1"></i> 25 Ноября • 10:00</p>
                    
                    <button onclick="openChecklist()" class="w-full bg-white text-brand-dark font-bold py-2.5 rounded-xl text-sm hover:bg-gray-100 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-list-check text-brand-500"></i>
                        Открыть чек-лист сборов
                    </button>
                </div>
            </div>

            <h2 class="text-xl font-extrabold text-gray-900 mb-4">Барахолка клуба</h2>
            <div class="grid grid-cols-2 gap-3 pb-20">
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="bg-gray-100 h-24 rounded-lg mb-2 flex items-center justify-center text-gray-300">
                        <i class="fa-solid fa-mask text-3xl"></i>
                    </div>
                    <p class="font-bold text-sm text-gray-800 leading-tight">Маска PBT 1600N</p>
                    <p class="text-[10px] text-gray-400 mb-2">Размер S • Б/У</p>
                    <div class="mt-auto flex justify-between items-center">
                        <span class="font-bold text-brand-600 text-sm">3500 ₽</span>
                        <button onclick="buyItem('Маска PBT')" class="bg-brand-50 text-brand-600 hover:bg-brand-500 hover:text-white transition w-8 h-8 rounded-full text-xs flex items-center justify-center"><i class="fa-regular fa-comment-dots"></i></button>
                    </div>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="bg-gray-100 h-24 rounded-lg mb-2 flex items-center justify-center text-gray-300">
                        <i class="fa-solid fa-tshirt text-3xl"></i>
                    </div>
                    <p class="font-bold text-sm text-gray-800 leading-tight">Куртка фехт.</p>
                    <p class="text-[10px] text-gray-400 mb-2">Рост 140 • Как новая</p>
                    <div class="mt-auto flex justify-between items-center">
                        <span class="font-bold text-brand-600 text-sm">2000 ₽</span>
                        <button onclick="buyItem('Куртка фехт.')" class="bg-brand-50 text-brand-600 hover:bg-brand-500 hover:text-white transition w-8 h-8 rounded-full text-xs flex items-center justify-center"><i class="fa-regular fa-comment-dots"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. BALANCE -->
        <div id="tab-finance" class="tab-content px-4 pt-4">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4">Баланс</h2>
            
            <div class="bg-white rounded-2xl p-6 text-center shadow-sm border border-gray-100 mb-6">
                <p class="text-sm text-gray-400 font-medium">Текущий баланс</p>
                <h3 class="text-4xl font-extrabold text-brand-dark my-2">
                    <span id="finance-balance-display">...</span> 
                    <span class="text-lg text-gray-400 font-normal">занятия</span>
                </h3>
                <p class="text-xs text-gray-400 mb-4">Действует до 15.11.2025</p>
                <button onclick="openPaymentModal()" class="w-full bg-brand-500 hover:bg-brand-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-200 transition-all active:scale-95">
                    Пополнить абонемент
                </button>
            </div>
        </div>


        <!-- === BOTTOM NAVIGATION === -->
        <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-100 py-2 px-4 flex justify-between items-center z-40 pb-safe">
            <button onclick="showTab('home')" class="nav-btn active flex flex-col items-center p-2 text-brand-500 transition-colors" data-target="home">
                <i class="fa-solid fa-house text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Главная</span>
            </button>
            <button onclick="showTab('calendar')" class="nav-btn flex flex-col items-center p-2 text-gray-300 hover:text-brand-500 transition-colors" data-target="calendar">
                <i class="fa-solid fa-calendar text-xl mb-1"></i>
                <span class="text-[10px] font-medium">План</span>
            </button>
            <button onclick="showTab('reports')" class="nav-btn flex flex-col items-center p-2 text-gray-300 hover:text-brand-500 transition-colors" data-target="reports">
                <div class="relative">
                    <i class="fa-solid fa-chart-simple text-xl mb-1"></i>
                    <div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full border border-white"></div>
                </div>
                <span class="text-[10px] font-medium">Отчеты</span>
            </button>
            <button onclick="showTab('market')" class="nav-btn flex flex-col items-center p-2 text-gray-300 hover:text-brand-500 transition-colors" data-target="market">
                <i class="fa-solid fa-users text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Клуб</span>
            </button>
            <button onclick="showTab('finance')" class="nav-btn flex flex-col items-center p-2 text-gray-300 hover:text-brand-500 transition-colors" data-target="finance">
                <i class="fa-solid fa-wallet text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Баланс</span>
            </button>
        </nav>

    </div>

    <!-- === MODALS === -->

    <!-- Payment Requisites Modal -->
    <div id="payment-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 transform scale-95 transition-transform duration-300" id="payment-content">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-extrabold text-gray-900">Пополнение абонемента</h3>
                <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4">
                <p class="text-xs text-gray-500 uppercase font-bold mb-2">Реквизиты для перевода</p>
                <p class="text-sm font-bold text-gray-800 mb-1">Сбербанк / Тинькофф</p>
                <p class="text-lg font-mono font-bold text-brand-600 mb-2">+7 (999) 123-45-67</p>
                <p class="text-xs text-gray-500">Получатель: Виктор Александрович П.</p>
                
                <div class="h-px bg-gray-200 my-3"></div>
                
                <p class="text-xs text-gray-500 mb-1">В комментарии укажите:</p>
                <p class="text-sm font-medium italic text-gray-700" id="payment-comment-text">"Оплата за ..."</p>
            </div>
            
            <button onclick="closePaymentModal()" class="w-full bg-brand-dark text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform">
                Понятно
            </button>
        </div>
    </div>

    <!-- Checklist Modal -->
    <div id="checklist-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 transform scale-95 transition-transform duration-300" id="checklist-content">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-extrabold text-gray-900">Сборы на турнир</h3>
                <button onclick="closeChecklist()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <p class="text-xs text-gray-500 mb-4">Не забудьте проверить все пункты перед выездом.</p>
            
            <div class="space-y-3 mb-6">
                 <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="checkbox" class="hidden custom-checkbox">
                    <div class="w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center transition-colors group-hover:border-brand-400">
                        <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-700">Фехтовальная маска</span>
                </label>
                 <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="checkbox" class="hidden custom-checkbox">
                    <div class="w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center transition-colors group-hover:border-brand-400">
                        <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-700">Костюм (Куртка + Штаны)</span>
                </label>
            </div>
            
            <button onclick="closeChecklist()" class="w-full bg-brand-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform">
                Готово, мы собрались!
            </button>
        </div>
    </div>

    <!-- Report Detail Modal -->
    <div id="detail-modal" class="fixed inset-x-0 bottom-0 top-0 z-50 transform translate-y-full transition-transform duration-300 max-w-md mx-auto pointer-events-none">
        <div class="absolute inset-0 bg-black/20 pointer-events-auto" onclick="closeReportModal()"></div>
        <div class="absolute inset-0 bg-white overflow-y-auto pointer-events-auto flex flex-col h-full mt-10 rounded-t-3xl shadow-2xl">
                <div class="p-4 flex-grow">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <div id="modal-content" class="pb-10"></div>
                </div>
        </div>
    </div>

    <!-- Absence Report Modal -->
    <div id="absence-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-solid fa-calendar-xmark text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Сообщить о пропуске</h3>
                <p class="text-sm text-gray-500">Пожалуйста, выберите дату и причину.</p>
            </div>
            
            <input type="date" class="w-full border border-gray-200 rounded-xl p-3 mb-3 text-sm" value="2025-10-22">
            
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button class="bg-gray-100 text-gray-600 py-2 rounded-lg text-xs font-bold hover:bg-brand-50 hover:text-brand-500 border border-transparent hover:border-brand-200">Болезнь</button>
                <button class="bg-gray-100 text-gray-600 py-2 rounded-lg text-xs font-bold hover:bg-brand-50 hover:text-brand-500 border border-transparent hover:border-brand-200">Семейные</button>
                <button class="bg-gray-100 text-gray-600 py-2 rounded-lg text-xs font-bold hover:bg-brand-50 hover:text-brand-500 border border-transparent hover:border-brand-200">Отъезд</button>
                <button class="bg-gray-100 text-gray-600 py-2 rounded-lg text-xs font-bold hover:bg-brand-50 hover:text-brand-500 border border-transparent hover:border-brand-200">Другое</button>
            </div>

            <button onclick="document.getElementById('absence-modal').classList.add('hidden'); alert('Тренер уведомлен!');" class="w-full bg-brand-500 text-white font-bold py-3 rounded-xl">
                Отправить
            </button>
            <button onclick="document.getElementById('absence-modal').classList.add('hidden')" class="w-full text-gray-400 font-bold py-3 mt-1 text-sm">
                Отмена
            </button>
        </div>
    </div>


    <!-- === JAVASCRIPT LOGIC === -->
    <script>
        // CONFIGURATION
        const API_KEY = "01ysvZCduYTq4mTY8paZUqH2EF0qy8Jd1oFHVONhaPZ9ggrFrOS0"; 
        const API_URL = "https://api.moyklass.com/v1"; // Official API
        const CABINET_URL = "https://manuel.tvoyklass.com"; // Your Cabinet

        // MOCK CLIENT (For Demo Mode)
        class MockMoyKlassClient {
            async loginUser(email, password) {
                await new Promise(r => setTimeout(r, 600));
                return { 
                    success: true, 
                    data: [
                        { id: 101, name: 'Александр', balance: 4.0, attributes: { rank: 'Мушкетер', xp: 1250, streak: 12, nextXp: 1500 } },
                        { id: 102, name: 'Руфина', balance: 6.0, attributes: { rank: 'Фехтовальщик', xp: 950, streak: 8, nextXp: 1000 } }
                    ] 
                };
            }
            async getStudentReports(userId) {
                if(userId === 101) return [{ id: 1, month: 'Октябрь 2025', comment: 'Саша стал лучше держать дистанцию.' }];
                return [{ id: 2, month: 'Декабрь 2025', comment: 'Хороший прогресс в защите.' }];
            }
            async getNextLesson(userId) {
                return { date: 'Завтра', time: '18:00', title: 'Групповая тренировка', location: 'Зал на Ленина' };
            }
        }

        // REAL CLIENT (For Production)
        class RealMoyKlassClient {
            constructor(token) {
                this.token = token;
                this.headers = { 
                    'x-access-token': this.token,
                    'Content-Type': 'application/json'
                };
            }

            // 1. Get User (by Email)
            async loginUser(email, password) {
                try {
                    // Note: Validating user password directly via Company API isn't typically exposed.
                    // We verify user existence by email.
                    // Endpoint: /company/users?email=...
                    if(!password || password.length < 1) throw new Error("Password empty");

                    const res = await fetch(`${API_URL}/company/users?email=${encodeURIComponent(email)}`, { headers: this.headers });
                    if(!res.ok) throw new Error(res.status);
                    const data = await res.json();
                    
                    const users = data.map(u => ({
                        id: u.id,
                        name: u.name,
                        balance: u.balance ? u.balance.toFixed(1) : "0.0",
                        attributes: {
                            rank: this.findAttribute(u, 'rank') || 'Новичок', 
                            xp: this.findAttribute(u, 'xp') || 0,
                            nextXp: 1000, 
                            streak: this.findAttribute(u, 'streak') || 0
                        }
                    }));
                    
                    return { success: true, data: users };
                } catch (e) {
                    console.error("API Error:", e);
                    throw e;
                }
            }

            findAttribute(user, code) {
                // Placeholder for Custom Fields logic
                if(user.customFields && Array.isArray(user.customFields)) {
                    // Logic to find field by ID needed here based on specific account setup
                    return null;
                }
                return null; 
            }

            // 2. Get Lessons (Schedule)
            async getNextLesson(userId) {
                try {
                    const res = await fetch(`${API_URL}/company/users/${userId}/joins?status=planned&limit=1`, { headers: this.headers });
                    if(!res.ok) return null;
                    const data = await res.json();
                    if(data && data.length > 0) {
                        const lesson = data[0];
                        const dateObj = new Date(lesson.date);
                        return {
                            date: dateObj.toLocaleDateString('ru-RU', {weekday:'short', day:'numeric'}),
                            time: lesson.beginTime || '??:??',
                            title: lesson.name || 'Тренировка',
                            location: 'Зал' 
                        };
                    }
                    return null;
                } catch (e) { return null; }
            }

            // 3. Reports (Comments/Reviews)
            async getStudentReports(userId) {
                try {
                    const res = await fetch(`${API_URL}/company/users/${userId}/comments`, { headers: this.headers });
                    if(!res.ok) return [];
                    const data = await res.json();
                    return data.map(c => ({
                        id: c.id,
                        month: new Date(c.createdAt).toLocaleDateString('ru-RU', {month:'long'}),
                        year: new Date(c.createdAt).getFullYear(),
                        comment: c.text
                    }));
                } catch(e) { return []; }
            }
        }

        let api; 
        let state = { currentUser: null, siblings: [], reports: [] };

        // LOGIN
        async function handleLogin() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const btn = document.getElementById('login-btn');
            const err = document.getElementById('login-error');
            const corsWarn = document.getElementById('cors-warning');
            
            err.classList.add('hidden');
            corsWarn.classList.add('hidden');

            if(!email || !email.includes('@')) { alert('Введите корректный Email'); return; }
            if(!password) { alert('Введите пароль'); return; }

            api = new RealMoyKlassClient(API_KEY);

            btn.innerHTML = '...';
            btn.disabled = true;

            try {
                const res = await api.loginUser(email, password);
                if(res.success && res.data.length > 0) {
                    state.siblings = res.data;
                    await switchChild(state.siblings[0].id);
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'flex';
                    setTimeout(() => document.getElementById('main-app').classList.add('fade-in'), 10);
                } else {
                    throw new Error("User not found");
                }
            } catch(e) {
                console.error(e);
                err.textContent = "Ошибка входа. Пользователь не найден или ошибка сети.";
                err.classList.remove('hidden');
                corsWarn.classList.remove('hidden'); 
                btn.innerHTML = 'Войти';
                btn.disabled = false;
            }
        }

        // DEMO LOGIN
        async function loginAsDemo() {
            // Fill fake credentials visually
            document.getElementById('email-input').value = "demo@manuel.com";
            document.getElementById('password-input').value = "123456";
            
            api = new MockMoyKlassClient(); 
            const res = await api.loginUser('demo', 'pass');
            state.siblings = res.data;
            await switchChild(state.siblings[0].id);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            setTimeout(() => document.getElementById('main-app').classList.add('fade-in'), 10);
        }

        // APP LOGIC
        async function switchChild(id) {
            state.currentUser = state.siblings.find(u => u.id === id);
            renderSwitcher();
            updateUI();
            
            // Async load real data
            const reports = await api.getStudentReports(id);
            state.reports = reports;
            renderReports(reports);
            
            const lesson = await api.getNextLesson(id);
            if(lesson) {
                document.getElementById('next-lesson-date').textContent = lesson.date;
                document.getElementById('next-lesson-time').textContent = lesson.time;
                document.getElementById('next-lesson-title').textContent = lesson.title;
                document.getElementById('next-lesson-loc').textContent = lesson.location;
            } else {
                document.getElementById('next-lesson-title').textContent = "Нет занятий";
            }
        }

        function renderSwitcher() {
            const c = document.getElementById('children-container');
            c.innerHTML = '';
            state.siblings.forEach(child => {
                const active = child.id === state.currentUser.id;
                c.innerHTML += `<div onclick="switchChild(${child.id})" class="flex-shrink-0 px-3 py-1.5 rounded-full border text-xs font-bold cursor-pointer transition ${active ? 'bg-brand-500 text-white' : 'bg-white text-gray-500'}">${child.name}</div>`;
            });
        }

        function updateUI() {
            const u = state.currentUser;
            document.getElementById('header-username').textContent = u.name;
            document.getElementById('header-balance').textContent = u.balance;
            document.getElementById('finance-balance-display').textContent = u.balance;
            
            // Gamification (Safe check for attributes)
            const attrs = u.attributes || { rank: 'Новичок', xp: 0, nextXp: 1000, streak: 0 };
            document.getElementById('home-rank').textContent = attrs.rank;
            document.getElementById('home-xp').textContent = attrs.xp;
            document.getElementById('home-streak').innerHTML = `<i class="fa-solid fa-fire text-brand-500"></i> Серия: ${attrs.streak}`;
            document.getElementById('xp-bar').style.width = `${(attrs.xp/attrs.nextXp)*100}%`;
        }

        function renderReports(list) {
            const el = document.getElementById('reports-list');
            el.innerHTML = '';
            if(!list.length) { el.innerHTML = '<div class="text-center text-gray-400 text-xs py-4">Нет отчетов</div>'; return;}
            list.forEach(r => {
                el.innerHTML += `<div onclick="openReportDetail(${r.id})" class="bg-white rounded-2xl p-4 shadow-sm mb-3 cursor-pointer"><h3 class="font-bold text-sm">${r.month} ${r.year || ''}</h3><p class="text-xs text-gray-600 mt-1 line-clamp-2">${r.comment}</p></div>`;
            });
        }

        // TABS & MODALS
        function showTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('text-brand-500', 'active'));
            document.querySelector(`[data-target="${t}"]`).classList.add('text-brand-500', 'active');
        }
        function openReportDetail(id) {
            const r = state.reports.find(x => x.id === id);
            document.getElementById('modal-content').innerHTML = `<h2 class="text-xl font-bold mb-2">Отчет</h2><p class="text-gray-600">${r.comment}</p><button onclick="closeReportModal()" class="mt-4 w-full bg-brand-100 py-3 rounded-xl font-bold text-brand-700">Закрыть</button>`;
            document.getElementById('detail-modal').classList.remove('translate-y-full');
        }
        function closeReportModal() { document.getElementById('detail-modal').classList.add('translate-y-full'); }
        function openPaymentModal() { 
            if(state.currentUser) document.getElementById('payment-comment-text').textContent = `"Оплата за ${state.currentUser.name}"`;
            document.getElementById('payment-modal').classList.remove('hidden'); 
        }
        function closePaymentModal() { document.getElementById('payment-modal').classList.add('hidden'); }
        function openChecklist() { document.getElementById('checklist-modal').classList.remove('hidden'); }
        function closeChecklist() { document.getElementById('checklist-modal').classList.add('hidden'); }
        function reportAbsence() { document.getElementById('absence-modal').classList.remove('hidden'); }
        
        // Setup Date Picker visual (static for now)
        const days = ['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'];
        let dHtml = '';
        for(let i=0; i<5; i++) {
            dHtml += `<div class="flex-shrink-0 w-14 h-20 ${i===0?'bg-brand-500 text-white':'bg-white text-gray-600'} border rounded-xl flex flex-col items-center justify-center shadow-sm"><span class="text-xs opacity-80">${days[i]}</span><span class="text-xl font-bold">${20+i}</span></div>`;
        }
        document.getElementById('calendar-days').innerHTML = dHtml;

    </script>
</body>
</html>
