<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sports Academy Super App</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/imask"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6', // Blue theme
                            600: '#2563eb',
                            dark: '#1e3a8a',
                            accent: '#f59e0b', // Gold/Orange for awards
                            success: '#22c55e',
                            danger: '#ef4444'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        
        body { 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f3f4f6; 
            color: #1f2937;
        }
        
        /* Utility: Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-press:active { transform: scale(0.95); opacity: 0.8; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }

        /* Custom Checkbox */
        .custom-checkbox:checked + div { background-color: #3b82f6; border-color: #3b82f6; }
        .custom-checkbox:checked + div svg { display: block; }
    </style>
</head>
<body class="font-sans antialiased min-h-screen pb-24 bg-gray-50 text-gray-800">

    <!-- === LOGIN SCREEN === -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 transition-all duration-300">
        <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mb-6 shadow-sm">
            <i class="fa-solid fa-trophy text-brand-500 text-3xl"></i>
        </div>
        <h2 class="text-2xl font-extrabold mb-2 text-gray-900">Спорт Академия</h2>
        <p class="text-gray-400 mb-8 text-center text-sm px-4">Мобильный кабинет родителя</p>
        
        <form id="login-form" class="w-full space-y-4 max-w-sm">
            <div>
                <input type="tel" id="login-phone" placeholder="+7 (900) 000-00-00" 
                    class="w-full p-4 rounded-2xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-brand-500 outline-none transition-all font-medium text-lg text-center tracking-wider" required>
            </div>
            
            <button type="submit" class="w-full bg-brand-500 text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-blue-200 btn-press transition-all">
                Войти
            </button>
        </form>
        <p class="mt-6 text-xs text-gray-400">Версия: Super App (Demo)</p>
    </div>

    <!-- === MAIN APP === -->
    <div id="app-screen" class="max-w-md mx-auto min-h-screen hidden">
        
        <!-- Header -->
        <header class="bg-white p-4 sticky top-0 z-30 shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 font-bold border-2 border-white shadow-sm">
                            <i class="fa-solid fa-user-astronaut"></i>
                        </div>
                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></div>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Родитель</p>
                        <h1 class="text-lg font-extrabold text-brand-dark leading-none" id="header-parent-name">Александр И.</h1>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="tg.showPopup({message:'Чат с тренером'})" class="w-9 h-9 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-brand-50 hover:text-brand-500 transition">
                        <i class="fa-regular fa-paper-plane"></i>
                    </button>
                    <!-- Balance Badge -->
                    <div onclick="showTab('finance')" class="bg-gray-900 text-white px-3 py-1.5 rounded-xl flex items-center gap-2 shadow-lg active:scale-95 transition-transform cursor-pointer">
                        <i class="fa-solid fa-wallet text-brand-500 text-xs"></i>
                        <span class="text-xs font-bold whitespace-nowrap" id="header-balance">--</span>
                    </div>
                </div>
            </div>

            <!-- Child Switcher (Dynamic) -->
            <div class="flex space-x-2 overflow-x-auto no-scrollbar" id="children-container">
                <!-- JS Injected -->
            </div>
        </header>

        <!-- ================= SCREENS ================= -->

        <!-- 1. HOME SCREEN -->
        <div id="tab-home" class="tab-content active px-4 pt-4">
            
            <!-- Stories -->
            <div class="flex gap-3 overflow-x-auto no-scrollbar mb-6">
                <div class="min-w-[140px] bg-gradient-to-br from-blue-500 to-blue-700 text-white p-3 rounded-2xl shadow-md relative overflow-hidden">
                    <p class="text-[10px] font-bold opacity-80 mb-1">Важно</p>
                    <p class="text-xs font-bold leading-tight">31 декабря — выходной</p>
                    <i class="fa-regular fa-snowflake absolute -bottom-2 -right-2 text-5xl opacity-20"></i>
                </div>
                <div class="min-w-[140px] bg-gradient-to-br from-brand-500 to-orange-400 text-white p-3 rounded-2xl shadow-md relative overflow-hidden">
                    <p class="text-[10px] font-bold opacity-80 mb-1">Сборы</p>
                    <p class="text-xs font-bold leading-tight">Летний лагерь 2026</p>
                    <i class="fa-solid fa-campground absolute -bottom-2 -right-2 text-4xl opacity-20"></i>
                </div>
            </div>

            <!-- Gamification Card -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 relative overflow-hidden mb-4">
                <div class="absolute right-0 top-0 text-gray-50 opacity-50 text-9xl -mr-4 -mt-4 pointer-events-none">
                    <i class="fa-solid fa-medal"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <span class="bg-brand-100 text-brand-700 text-[10px] font-bold px-2 py-0.5 rounded mb-1 inline-block" id="home-rank-badge">...</span>
                            <h2 class="text-2xl font-extrabold text-brand-dark" id="home-rank">...</h2>
                        </div>
                        <div class="text-right">
                            <span class="text-xl font-bold text-brand-500" id="home-xp">...</span>
                            <span class="text-[10px] text-gray-400 font-bold uppercase">XP</span>
                        </div>
                    </div>
                    <!-- XP Bar -->
                    <div class="w-full bg-gray-100 rounded-full h-2.5 mb-2">
                        <div id="xp-bar" class="bg-gradient-to-r from-brand-500 to-cyan-400 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 flex items-center gap-1" id="home-streak">
                        <i class="fa-solid fa-fire text-brand-500"></i> ...
                    </p>
                </div>
            </div>

            <!-- Next Training -->
            <h3 class="text-sm font-bold text-gray-900 mb-2 px-1">Ближайшая тренировка</h3>
            <div class="bg-brand-dark text-white rounded-2xl p-4 shadow-lg mb-6 flex justify-between items-center relative overflow-hidden group cursor-pointer" onclick="showTab('calendar')">
                <div class="absolute inset-0 bg-brand-500 opacity-0 group-active:opacity-10 transition-opacity"></div>
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold backdrop-blur-sm">Завтра</span>
                        <span class="text-brand-500 font-bold text-sm">18:00</span>
                    </div>
                    <p class="font-bold text-lg">Отработка защиты</p>
                    <p class="text-xs text-gray-400"><i class="fa-solid fa-location-dot mr-1"></i>Зал на Ленина, 5</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-xl">
                    <i class="fa-solid fa-chevron-right"></i>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-3 gap-3 mb-20">
                <div onclick="openAbsenceModal()" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition-transform flex flex-col items-center justify-center text-center h-28 cursor-pointer">
                    <div class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center mb-2">
                        <i class="fa-solid fa-user-xmark"></i>
                    </div>
                    <p class="font-bold text-[11px] leading-tight">Сообщить<br>о пропуске</p>
                </div>
                
                <div onclick="showTab('calendar')" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition-transform flex flex-col items-center justify-center text-center h-28 cursor-pointer">
                    <div class="w-10 h-10 rounded-full bg-brand-50 text-brand-500 flex items-center justify-center mb-2">
                        <i class="fa-solid fa-calendar-day"></i>
                    </div>
                    <p class="font-bold text-[11px] leading-tight">Мое<br>расписание</p>
                </div>

                <div onclick="showTab('market')" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition-transform flex flex-col items-center justify-center text-center h-28 cursor-pointer">
                    <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center mb-2">
                        <i class="fa-solid fa-shop"></i>
                    </div>
                    <p class="font-bold text-[11px] leading-tight">Барахолка<br>клуба</p>
                </div>
            </div>
        </div>

        <!-- 2. CALENDAR SCREEN -->
        <div id="tab-calendar" class="tab-content px-4 pt-4">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4">Календарь занятий</h2>
            
            <!-- Mock Dates -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-2">
                <div class="flex-shrink-0 w-14 h-20 bg-brand-500 rounded-xl flex flex-col items-center justify-center text-white shadow-lg transform scale-105">
                    <span class="text-xs font-medium opacity-80">ПН</span><span class="text-xl font-bold">20</span>
                </div>
                <div class="flex-shrink-0 w-14 h-20 bg-white border border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-600">
                    <span class="text-xs font-medium text-gray-400">ВТ</span><span class="text-xl font-bold">21</span>
                </div>
                <div class="flex-shrink-0 w-14 h-20 bg-white border border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-600 relative">
                    <span class="text-xs font-medium text-gray-400">СР</span><span class="text-xl font-bold">22</span>
                    <div class="absolute bottom-2 w-1.5 h-1.5 bg-red-500 rounded-full"></div>
                </div>
                <div class="flex-shrink-0 w-14 h-20 bg-white border border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-600">
                    <span class="text-xs font-medium text-gray-400">ЧТ</span><span class="text-xl font-bold">23</span>
                </div>
            </div>

            <!-- List -->
            <div class="space-y-3 pb-20">
                <div class="bg-white rounded-xl p-4 border-l-4 border-brand-500 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">Групповая тренировка</p>
                            <p class="text-xs text-gray-500 mt-1">18:00 - 19:30 • Тренер Виктор</p>
                        </div>
                        <span class="bg-brand-50 text-brand-600 text-[10px] font-bold px-2 py-1 rounded">Завтра</span>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 border-l-4 border-green-500 shadow-sm opacity-70">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">Спарринги</p>
                            <p class="text-xs text-gray-500 mt-1">18 Октября</p>
                        </div>
                        <span class="text-green-600 text-xs font-bold"><i class="fa-solid fa-check-circle"></i> Был</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. REPORTS SCREEN -->
        <div id="tab-reports" class="tab-content px-4 pt-4">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4">Отчеты успеваемости</h2>
            <div id="reports-list" class="space-y-4 pb-20">
                <!-- JS Injected -->
            </div>
        </div>

        <!-- 4. MARKET SCREEN -->
        <div id="tab-market" class="tab-content px-4 pt-4">
            <!-- Banner -->
            <div class="bg-gradient-to-br from-brand-dark to-gray-800 text-white rounded-2xl p-5 shadow-lg mb-8 relative overflow-hidden">
                <div class="absolute right-0 bottom-0 opacity-10 text-9xl -mr-6 -mb-6"><i class="fa-solid fa-trophy"></i></div>
                <div class="relative z-10">
                    <span class="bg-yellow-400 text-black text-[10px] font-bold px-2 py-0.5 rounded mb-2 inline-block">Важно</span>
                    <h3 class="text-xl font-bold mb-1">Кубок "Юная Шпага"</h3>
                    <p class="text-xs text-gray-300 mb-4">25 Ноября • 10:00</p>
                    <button onclick="openChecklist()" class="w-full bg-white text-brand-dark font-bold py-2.5 rounded-xl text-sm hover:bg-gray-100 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-list-check text-brand-500"></i> Открыть чек-лист
                    </button>
                </div>
            </div>
            
            <h2 class="text-xl font-extrabold text-gray-900 mb-4">Барахолка клуба</h2>
            <div class="grid grid-cols-2 gap-3 pb-20" id="market-list">
                <!-- JS Injected -->
            </div>
        </div>

        <!-- 5. FINANCE SCREEN -->
        <div id="tab-finance" class="tab-content px-4 pt-4">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4">Финансы</h2>
            
            <div class="bg-white rounded-2xl p-6 text-center shadow-sm border border-gray-100 mb-6">
                <p class="text-sm text-gray-400 font-medium">Текущий баланс</p>
                <h3 class="text-4xl font-extrabold text-brand-dark my-2" id="finance-display">...</h3>
                <p class="text-xs text-gray-400 mb-4">Действует до 15.11.2025</p>
                <button class="w-full bg-brand-500 hover:bg-brand-600 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95">
                    Пополнить
                </button>
            </div>

            <h3 class="text-sm font-bold text-gray-900 mb-2">История операций</h3>
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 divide-y divide-gray-100">
                <div class="p-4 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm">Абонемент (8 зан.)</p>
                        <p class="text-[10px] text-gray-400">15 Октября</p>
                    </div>
                    <span class="text-red-500 font-bold text-sm">- 4500 ₽</span>
                </div>
                <div class="p-4 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm">Турнирный взнос</p>
                        <p class="text-[10px] text-gray-400">10 Октября</p>
                    </div>
                    <span class="text-red-500 font-bold text-sm">- 1000 ₽</span>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-100 py-2 px-6 flex justify-between items-center z-40 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button onclick="showTab('home')" class="nav-btn active flex flex-col items-center p-2 text-brand-500 transition-colors" data-target="home">
                <i class="fa-solid fa-house text-xl mb-1"></i> <span class="text-[10px] font-bold">Главная</span>
            </button>
            <button onclick="showTab('calendar')" class="nav-btn flex flex-col items-center p-2 text-gray-300 hover:text-brand-500 transition-colors" data-target="calendar">
                <i class="fa-solid fa-calendar text-xl mb-1"></i> <span class="text-[10px] font-medium">План</span>
            </button>
            <button onclick="showTab('reports')" class="nav-btn flex flex-col items-center p-2 text-gray-300 hover:text-brand-500 transition-colors" data-target="reports">
                <div class="relative"><i class="fa-solid fa-chart-simple text-xl mb-1"></i><div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full border border-white"></div></div> <span class="text-[10px] font-medium">Отчеты</span>
            </button>
            <button onclick="showTab('market')" class="nav-btn flex flex-col items-center p-2 text-gray-300 hover:text-brand-500 transition-colors" data-target="market">
                <i class="fa-solid fa-users text-xl mb-1"></i> <span class="text-[10px] font-medium">Клуб</span>
            </button>
        </nav>

    </div>

    <!-- === MODALS === -->

    <!-- Checklist Modal -->
    <div id="checklist-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-extrabold text-gray-900">Чек-лист: Турнир</h3>
                <button onclick="closeChecklist()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-3 cursor-pointer group"><input type="checkbox" class="hidden custom-checkbox"><div class="w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center transition-colors"><svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><span class="text-sm font-medium text-gray-700">Маска + Костюм</span></label>
                <label class="flex items-center gap-3 cursor-pointer group"><input type="checkbox" class="hidden custom-checkbox"><div class="w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center transition-colors"><svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><span class="text-sm font-medium text-gray-700">Перчатка + Шнур</span></label>
                <label class="flex items-center gap-3 cursor-pointer group"><input type="checkbox" class="hidden custom-checkbox"><div class="w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center transition-colors"><svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><span class="text-sm font-medium text-gray-700">Вода и перекус</span></label>
            </div>
            <button onclick="closeChecklist()" class="w-full bg-brand-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform">Готово</button>
        </div>
    </div>

    <!-- Report Detail Modal -->
    <div id="detail-modal" class="fixed inset-x-0 bottom-0 top-0 z-50 transform translate-y-full transition-transform duration-300 max-w-md mx-auto pointer-events-none">
        <div class="absolute inset-0 bg-black/20 pointer-events-auto" onclick="closeReportModal()"></div>
        <div class="absolute inset-0 bg-white overflow-y-auto pointer-events-auto flex flex-col h-full mt-10 rounded-t-3xl shadow-2xl">
            <div class="p-6 flex-grow">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <div id="modal-content" class="pb-10"></div>
            </div>
        </div>
    </div>

    <!-- Absence Modal -->
    <div id="absence-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-3"><i class="fa-solid fa-calendar-xmark text-xl"></i></div>
                <h3 class="text-lg font-bold text-gray-900">Причина пропуска</h3>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="confirmAbsence()" class="bg-gray-100 text-gray-600 py-3 rounded-xl text-sm font-bold hover:bg-brand-50 hover:text-brand-500">Болезнь</button>
                <button onclick="confirmAbsence()" class="bg-gray-100 text-gray-600 py-3 rounded-xl text-sm font-bold hover:bg-brand-50 hover:text-brand-500">Семейные</button>
                <button onclick="confirmAbsence()" class="bg-gray-100 text-gray-600 py-3 rounded-xl text-sm font-bold hover:bg-brand-50 hover:text-brand-500">Отъезд</button>
                <button onclick="confirmAbsence()" class="bg-gray-100 text-gray-600 py-3 rounded-xl text-sm font-bold hover:bg-brand-50 hover:text-brand-500">Другое</button>
            </div>
            <button onclick="document.getElementById('absence-modal').classList.add('hidden')" class="w-full text-gray-400 font-bold py-2 text-sm">Отмена</button>
        </div>
    </div>

    <!-- === JAVASCRIPT LOGIC (OFFLINE DB) === -->
    <script>
        // Init Phone Mask
        const phoneInput = document.getElementById('login-phone');
        IMask(phoneInput, { mask: '+{7} (000) 000-00-00' });

        // --- MOCK DATABASE ---
        const db = {
            children: [
                { id: 1, name: 'Александр', rank: 'Мушкетер', xp: 1250, nextXp: 1500, balance: 4, streak: 12 },
                { id: 2, name: 'София', rank: 'Новичок', xp: 450, nextXp: 500, balance: 1, streak: 3 },
                { id: 3, name: 'Руфина', rank: 'Фехтовальщик', xp: 950, nextXp: 1000, balance: 6, streak: 8 }
            ],
            reports: {
                1: [{ id: 101, title: 'Итоги Октября', date: '31.10.25', xp: '+15', comment: 'Саша стал лучше держать дистанцию.', details: ['Техника: Хорошо', 'Тактика: Средне'] }],
                2: [{ id: 201, title: 'Первые шаги', date: '30.10.25', xp: '+50', comment: 'Отличное начало!', details: ['Дисциплина: Отлично'] }],
                3: [{ id: 301, title: 'Декабрь', date: '25.12.25', xp: '+20', comment: 'Стабильный прогресс.', details: ['Стойка: Уверенно', 'Выпады: Нужно работать'] }]
            },
            market: [
                { id: 1, title: 'Маска PBT 1600N', price: '3500 ₽', sub: 'Размер S • Б/У', icon: 'fa-mask' },
                { id: 2, title: 'Куртка фехт.', price: '2000 ₽', sub: 'Рост 140', icon: 'fa-tshirt' }
            ]
        };

        let currentChildId = 1;
        let tg = window.Telegram.WebApp;

        // --- APP LOGIC ---

        function init() {
            renderChildren();
            loadChildData(currentChildId);
            renderMarket();
        }

        // Login Flow
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Вход...';
            setTimeout(() => {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('fade-in');
                init();
            }, 800);
        });

        // Child Switcher
        function renderChildren() {
            const container = document.getElementById('children-container');
            container.innerHTML = db.children.map(c => `
                <button onclick="switchChild(${c.id})" class="flex items-center gap-2 px-3 py-1.5 rounded-full border transition-all whitespace-nowrap ${currentChildId === c.id ? 'bg-brand-500 text-white border-brand-500 shadow-md transform scale-105' : 'bg-white text-gray-500 border-gray-200'}">
                    <span class="text-xs font-bold">${c.name}</span>
                </button>
            `).join('');
        }

        function switchChild(id) {
            currentChildId = id;
            renderChildren();
            loadChildData(id);
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        function loadChildData(id) {
            const child = db.children.find(c => c.id === id);
            // Header
            document.getElementById('header-balance').innerText = `${child.balance} зан.`;
            document.getElementById('finance-display').innerText = `${child.balance} зан.`;
            
            // Home Gamification
            document.getElementById('home-rank').innerText = child.rank;
            document.getElementById('home-rank-badge').innerText = `Уровень ${Math.floor(child.xp/500)+1}`;
            document.getElementById('home-xp').innerText = child.xp;
            document.getElementById('home-streak').innerHTML = `<i class="fa-solid fa-fire text-brand-500"></i> Серия: ${child.streak} зан.`;
            
            // Bar animation
            setTimeout(() => {
                document.getElementById('xp-bar').style.width = `${(child.xp/child.nextXp)*100}%`;
            }, 100);

            renderReports(id);
        }

        function renderReports(id) {
            const list = document.getElementById('reports-list');
            const data = db.reports[id] || [];
            if(data.length === 0) { list.innerHTML = '<p class="text-center text-gray-400 text-xs">Нет отчетов</p>'; return; }
            
            list.innerHTML = data.map(r => `
                <div onclick="openReportModal(${r.id})" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition-transform cursor-pointer">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-[10px] font-bold text-gray-400 uppercase">${r.date}</span>
                            <h3 class="font-bold text-gray-800">${r.title}</h3>
                        </div>
                        <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-0.5 rounded">${r.xp} XP</span>
                    </div>
                    <p class="text-xs text-gray-500 line-clamp-2">${r.comment}</p>
                </div>
            `).join('');
        }

        function renderMarket() {
            document.getElementById('market-list').innerHTML = db.market.map(m => `
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="bg-gray-100 h-24 rounded-lg mb-2 flex items-center justify-center text-gray-300"><i class="fa-solid ${m.icon} text-3xl"></i></div>
                    <p class="font-bold text-sm text-gray-800 leading-tight">${m.title}</p>
                    <p class="text-[10px] text-gray-400 mb-2">${m.sub}</p>
                    <div class="mt-auto flex justify-between items-center">
                        <span class="font-bold text-brand-600 text-sm">${m.price}</span>
                        <button onclick="alert('Связываемся с продавцом...')" class="bg-brand-50 text-brand-600 w-8 h-8 rounded-full text-xs flex items-center justify-center"><i class="fa-regular fa-comment-dots"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // --- MODALS & NAVIGATION ---

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const active = btn.dataset.target === tabId;
                btn.classList.toggle('text-brand-500', active);
                btn.classList.toggle('text-gray-300', !active);
            });
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        function openChecklist() {
            const m = document.getElementById('checklist-modal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.remove('opacity-0'), 10);
        }
        function closeChecklist() {
            const m = document.getElementById('checklist-modal');
            m.classList.add('opacity-0');
            setTimeout(() => m.classList.add('hidden'), 300);
        }

        function openAbsenceModal() {
            document.getElementById('absence-modal').classList.remove('hidden');
        }
        function confirmAbsence() {
            document.getElementById('absence-modal').classList.add('hidden');
            if(tg.showPopup) tg.showPopup({title:'Принято', message:'Тренер уведомлен.'});
            else alert('Тренер уведомлен!');
        }

        function openReportModal(rid) {
            // Find report
            const childReports = db.reports[currentChildId];
            const r = childReports.find(x => x.id === rid);
            if(!r) return;

            document.getElementById('modal-content').innerHTML = `
                <h2 class="text-2xl font-bold mb-2">${r.title}</h2>
                <div class="bg-brand-50 p-4 rounded-xl mb-4"><p class="text-sm text-brand-900 italic">"${r.comment}"</p></div>
                <h3 class="font-bold text-sm mb-2">Детали:</h3>
                <ul class="space-y-2 text-sm text-gray-600">${r.details.map(d => `<li class="border-b border-gray-100 pb-1 flex justify-between"><span>${d.split(':')[0]}</span><span class="font-bold text-gray-900">${d.split(':')[1]}</span></li>`).join('')}</ul>
                <button onclick="closeReportModal()" class="w-full mt-8 bg-gray-100 font-bold py-3 rounded-xl text-gray-600">Закрыть</button>
            `;
            document.getElementById('detail-modal').classList.remove('translate-y-full');
        }
        function closeReportModal() {
            document.getElementById('detail-modal').classList.add('translate-y-full');
        }

        function logout() {
            if(confirm('Выйти?')) location.reload();
        }
    </script>
</body>
</html>
